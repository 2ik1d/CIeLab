<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CIELab Color Tool</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: sans-serif; max-width: 1100px; margin: auto; }
  input { width: 60px; margin: 2px; }
  .row { margin: 5px 0; }
</style>
</head>
<body>

<h2>CIELab Color Visualization Tool</h2>

<div class="row">
  <strong>Эталон (Reference):</strong><br>
  L*: <input id="L1" value="55"> 
  a*: <input id="a1" value="20"> 
  b*: <input id="b1" value="30">
</div>

<div class="row">
  <strong>Образец (Sample):</strong><br>
  L*: <input id="L2" value="53.5"> 
  a*: <input id="a2" value="18"> 
  b*: <input id="b2" value="25">
</div>

<button onclick="updatePlot()">Построить</button>

<div id="metrics" style="margin-top:10px; font-size:14px;"></div>
<div id="plotAB" style="width:100%; height:500px;"></div>
<div id="plotCL" style="width:100%; height:400px;"></div>

<script>
// ---------- Color conversions ----------
function labToXyz(L,a,b){
    const Xn=95.047, Yn=100.0, Zn=108.883;
    let fy=(L+16)/116;
    let fx=fy+a/500;
    let fz=fy-b/200;
    let xr = (fx**3 > 0.008856) ? fx**3 : (fx-16/116)/7.787;
    let yr = (fy**3 > 0.008856) ? fy**3 : (fy-16/116)/7.787;
    let zr = (fz**3 > 0.008856) ? fz**3 : (fz-16/116)/7.787;
    return [xr*Xn, yr*Yn, zr*Zn];
}
function xyzToRgb(X,Y,Z){
    X/=100; Y/=100; Z/=100;
    let r = X*3.2406 + Y*-1.5372 + Z*-0.4986;
    let g = X*-0.9689 + Y*1.8758 + Z*0.0415;
    let b = X*0.0557 + Y*-0.2040 + Z*1.0570;
    function compand(c){ return (c<=0.0031308)? 12.92*c : 1.055*(c**(1/2.4))-0.055; }
    return [r,g,b].map(v => Math.min(Math.max(compand(v),0),1));
}
function labToRgb(L,a,b){
    return xyzToRgb(...labToXyz(L,a,b));
}
// ---------- Metrics ----------
function chroma(a,b){ return Math.sqrt(a*a + b*b); }
function hueDeg(a,b){ let ang=Math.atan2(b,a)*180/Math.PI; return (ang<0)?ang+360:ang; }
function deltaE76(l1,a1,b1,l2,a2,b2){
    return Math.sqrt((l1-l2)**2 + (a1-a2)**2 + (b1-b2)**2);
}
function deltaE00(lab1, lab2){
    const [L1,a1,b1] = lab1;
    const [L2,a2,b2] = lab2;
    const deg2rad = d => d * Math.PI/180, rad2deg = r => r*180/Math.PI;
    const C1 = Math.sqrt(a1*a1 + b1*b1), C2 = Math.sqrt(a2*a2 + b2*b2);
    const Cbar = (C1 + C2)/2;
    const G = 0.5 * (1 - Math.sqrt((Cbar**7)/(Cbar**7 + 25**7)));
    const a1p = (1+G)*a1, a2p = (1+G)*a2;
    const C1p = Math.sqrt(a1p*a1p + b1*b1), C2p = Math.sqrt(a2p*a2p + b2*b2);
    const h1p = (Math.atan2(b1,a1p)*180/Math.PI+360)%360;
    const h2p = (Math.atan2(b2,a2p)*180/Math.PI+360)%360;
    const dLp = L2 - L1, dCp = C2p - C1p;
    let dhp;
    if (C1p*C2p===0) dhp=0;
    else {
        let dh = h2p - h1p;
        if (dh>180) dh-=360; else if (dh<-180) dh+=360;
        dhp = dh;
    }
    const dHp = 2*Math.sqrt(C1p*C2p)*Math.sin(deg2rad(dhp/2));
    const Lbarp = (L1+L2)/2, Cbarp = (C1p+C2p)/2;
    let hbarp;
    if (C1p*C2p===0) hbarp=h1p+h2p;
    else {
        let dh=Math.abs(h1p-h2p);
        if (dh>180) { hbarp = (h1p+h2p<360)?(h1p+h2p+360)/2:(h1p+h2p-360)/2; }
        else hbarp=(h1p+h2p)/2;
    }
    const T = 1 - 0.17*Math.cos(deg2rad(hbarp-30))
                + 0.24*Math.cos(deg2rad(2*hbarp))
                + 0.32*Math.cos(deg2rad(3*hbarp+6))
                - 0.20*Math.cos(deg2rad(4*hbarp-63));
    const deltah = 30*Math.exp(-(((hbarp-275)/25)**2));
    const RC = 2*Math.sqrt((Cbarp**7)/(Cbarp**7+25**7));
    const SL = 1 + 0.015*((Lbarp-50)**2)/Math.sqrt(20+((Lbarp-50)**2));
    const SC = 1 + 0.045*Cbarp;
    const SH = 1 + 0.015*Cbarp*T;
    const RT = -Math.sin(deg2rad(2*deltah))*RC;
    return Math.sqrt((dLp/SL)**2 + (dCp/SC)**2 + (dHp/SH)**2 + RT*(dCp/SC)*(dHp/SH));
}
// ---------- Plot ----------
function updatePlot(){
    const L1=parseFloat(L1_el.value), a1=parseFloat(a1_el.value), b1=parseFloat(b1_el.value);
    const L2=parseFloat(L2_el.value), a2=parseFloat(a2_el.value), b2=parseFloat(b2_el.value);

    const dE76=deltaE76(L1,a1,b1,L2,a2,b2).toFixed(3);
    const dE00=deltaE00([L1,a1,b1],[L2,a2,b2]).toFixed(3);
    const C1=chroma(a1,b1).toFixed(2), C2=chroma(a2,b2).toFixed(2);
    const h1=hueDeg(a1,b1).toFixed(1), h2=hueDeg(a2,b2).toFixed(1);

    metrics.innerHTML = `<b>ΔE76:</b> ${dE76} | <b>ΔE00:</b> ${dE00}<br>
                         Ref: C=${C1}, h=${h1}° | Sample: C=${C2}, h=${h2}°`;

    // --- Background color circle ---
    let bgX=[], bgY=[], bgColor=[];
    const step=5;
    for(let A=-80;A<=80;A+=step){
        for(let B=-80;B<=80;B+=step){
            const rgb=labToRgb(60,A,B); // фиксируем L=60 для фона
            bgX.push(A); bgY.push(B);
            bgColor.push(`rgb(${rgb.map(v=>Math.round(v*255)).join(',')})`);
        }
    }
    const bg = {
        x:bgX, y:bgY, mode:'markers', marker:{size:8, color:bgColor}, hoverinfo:'skip', showlegend:false
    };
    const refPt = {x:[a1], y:[b1], mode:'markers', name:'Reference',
                   marker:{size:12, color:'blue', line:{width:2, color:'#000'}}};
    const samplePt = {x:[a2], y:[b2], mode:'markers', name:'Sample',
                      marker:{size:12, color:'red', line:{width:2, color:'#000'}}};
    const vector = {x:[a1,a2], y:[b1,b2], mode:'lines', name:'Vector', line:{dash:'dot', width:2, color:'#333'}};

    // Add chroma circles
    let shapes=[];
    for(let r=20;r<=80;r+=20){
        shapes.push({type:'circle', xref:'x', yref:'y', x0:-r, y0:-r, x1:r, y1:r, line:{color:'rgba(0,0,0,0.2)',width:1}});
    }
    const layoutAB = {
        xaxis:{title:'a*', range:[-85,85]}, yaxis:{title:'b*', range:[-85,85]},
        shapes: shapes, title:'CIELab a* vs b*', width:550, height:500
    };
    Plotly.newPlot('plotAB', [bg, refPt, samplePt, vector], layoutAB);

    // --- Chroma vs Lightness plot ---
    const refCL = {x:[C1], y:[L1], mode:'markers', name:'Reference', marker:{size:12, color:'blue'}};
    const sampCL = {x:[C2], y:[L2], mode:'markers', name:'Sample', marker:{size:12, color:'red'}};
    const layoutCL = {
        xaxis:{title:'Chroma (C)'}, yaxis:{title:'Lightness (L*)', range:[0,100]},
        title:'Chroma vs Lightness', width:550, height:400
    };
    Plotly.newPlot('plotCL', [refCL, sampCL], layoutCL);
}
// Cache inputs
const L1_el=document.getElementById('L1'), a1_el=document.getElementById('a1'), b1_el=document.getElementById('b1');
const L2_el=document.getElementById('L2'), a2_el=document.getElementById('a2'), b2_el=document.getElementById('b2');
updatePlot();
</script>

</body>
</html>
